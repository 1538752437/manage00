<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Muphy Coffee - 管理员界面</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { 
      font-family: 'Arial', sans-serif; 
      background: url('https://images.pexels.com/photos/1506619216599-9d16d0903dfd?auto=compress&cs=tinysrgb&w=1200') no-repeat center fixed; 
      background-size: cover; 
      color: #333; 
      position: relative; 
      overflow-x: hidden; 
      min-height: 100vh; 
    }
    body::before { 
      content: ''; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(255, 255, 255, 0.85); 
      z-index: -1; 
    }
    .admin-section { 
      padding: 40px 0; 
      background-color: #fff; 
      border-radius: 10px; 
      margin: 20px auto; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
      max-width: 1200px; 
      box-sizing: border-box; 
    }
    .container { 
      padding: 0 30px; 
      width: 100%; 
    }
    .form-control { 
      font-size: 1rem; 
      padding: 10px; 
      margin-bottom: 15px; 
    }
    .btn { 
      padding: 10px 20px; 
      font-size: 1rem; 
      touch-action: manipulation; 
      -webkit-tap-highlight-color: transparent; 
      transition: all 0.2s; 
    }
    .btn:hover { 
      transform: translateY(-1px); 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .btn-primary { 
      background-color: #6f4e37; 
      border-color: #6f4e37; 
    }
    .btn-primary:hover { 
      background-color: #5a3f2d; 
      border-color: #5a3f2d; 
    }
    .btn-primary:disabled { 
      background-color: #a88e6e; 
      border-color: #a88e6e; 
      cursor: not-allowed; 
    }
    .btn-success { 
      background-color: #28a745; 
      border-color: #28a745; 
    }
    .btn-success:hover { 
      background-color: #218838; 
      border-color: #218838; 
    }
    .btn-danger { 
      background-color: #dc3545; 
      border-color: #dc3545; 
    }
    .btn-danger:hover { 
      background-color: #c82333; 
      border-color: #c82333; 
    }
    .table { 
      background-color: #fff; 
      font-size: 1rem; 
    }
    .table th, .table td { 
      word-break: break-word; 
      padding: 12px; 
    }
    .table-hover tbody tr:hover { 
      background-color: #f8f9fa; 
    }
    .loading { 
      text-align: center; 
      color: #6f4e37; 
      font-style: italic; 
    }
    #admin-sections { 
      display: none; 
    }
    .error-message { 
      color: #dc3545; 
      font-size: 0.9rem; 
      margin-top: 5px; 
      display: none; 
    }
    .search-bar { 
      margin-bottom: 20px; 
    }
    .pagination { 
      margin-top: 20px; 
    }
    @media (max-width: 768px) {
      .admin-section { 
        margin: 10px; 
        padding: 15px 0; 
      }
      .container { 
        padding: 0 15px; 
      }
      .form-control { 
        font-size: 0.95rem; 
        padding: 8px; 
      }
      .btn { 
        font-size: 0.95rem; 
        padding: 8px 15px; 
      }
      .table { 
        font-size: 0.85rem; 
      }
    }
    @media (min-width: 769px) {
      .admin-section { 
        padding: 50px 0; 
      }
      .table-responsive { 
        overflow-x: auto; 
      }
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getDatabase, ref, push, onValue, remove, update, orderByChild, startAt, endAt, limitToFirst } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaVwadaKpdjtYPN1qWIvh6Rkben-Y5KQ",
      authDomain: "muphycoffee.firebaseapp.com",
      databaseURL: "https://muphycoffee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "muphycoffee",
      storageBucket: "muphycoffee.firebasestorage.app",
      messagingSenderId: "247009315808",
      appId: "1:247009315808:web:9a63a7648509cc42c0b985",
      measurementId: "G-B5ZT58WP1Q"
    };

    try {
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getDatabase(app);
      const auth = getAuth(app);

      let isAdmin = false;

      async function initializeAppLogic() {
        const loginContainer = document.getElementById('admin-login');
        const loginForm = loginContainer.querySelector('form');
        const loginButton = loginForm.querySelector('button[type="submit"]');
        const emailInput = loginContainer.querySelector('input[type="email"]');
        const passwordInput = loginContainer.querySelector('input[type="password"]');
        const errorMessage = document.getElementById('error-message');

        function showError(message) {
          errorMessage.textContent = message;
          errorMessage.style.display = 'block';
        }

        function clearError() {
          errorMessage.style.display = 'none';
          errorMessage.textContent = '';
        }

        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          clearError();

          const email = emailInput.value.trim();
          const password = passwordInput.value.trim();

          if (!email || !password) {
            showError('请输入邮箱和密码！');
            return;
          }

          loginButton.disabled = true;
          loginButton.textContent = '登录中...';

          try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            isAdmin = true;
            alert('登录成功！');
            loginContainer.style.display = 'none';
            document.getElementById('admin-sections').style.display = 'block';
            const logoutButton = document.createElement('button');
            logoutButton.type = 'button';
            logoutButton.textContent = '退出登录';
            logoutButton.className = 'btn btn-secondary mt-3';
            loginContainer.appendChild(logoutButton);
            logoutButton.addEventListener('click', async () => {
              await signOut(auth);
              alert('已退出登录！');
              isAdmin = false;
              document.getElementById('admin-sections').style.display = 'none';
              loginContainer.style.display = 'block';
              logoutButton.remove();
            });
            await loadProducts();
            await loadOrders();
          } catch (error) {
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
              showError('邮箱或密码错误，请重试！');
            } else if (error.code === 'auth/network-request-failed') {
              showError('网络连接失败，请检查网络后重试！');
            } else {
              showError('登录失败：' + error.message);
            }
          } finally {
            loginButton.disabled = false;
            loginButton.textContent = '登录';
          }
        });

        onAuthStateChanged(auth, (user) => {
          if (user) {
            isAdmin = true;
            document.getElementById('admin-sections').style.display = 'block';
            loginContainer.style.display = 'none';
            loadProducts();
            loadOrders();
          } else {
            isAdmin = false;
            document.getElementById('admin-sections').style.display = 'none';
            loginContainer.style.display = 'block';
          }
        });

        const addProductForm = document.querySelector('#add-product form');
        if (addProductForm) {
          addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) {
              alert('请先登录管理员账户！');
              return;
            }
            const name = document.querySelector('#add-product input[name="name"]').value.trim();
            const price = parseFloat(document.querySelector('#add-product input[name="price"]').value);
            const description = document.querySelector('#add-product textarea[name="description"]').value.trim();
            const category = document.querySelector('#add-product select[name="category"]').value;
            const imageUrl = document.querySelector('#add-product input[name="imageUrl"]').value.trim();
            if (!name || isNaN(price) || !description || !category) {
              alert('请填写所有必填字段！');
              return;
            }
            try {
              await push(ref(db, 'products'), {
                name, price, description, category,
                imageUrl: imageUrl || 'https://images.pexels.com/photos/3400193/pexels-photo-3400193.jpeg?auto=compress&cs=tinysrgb&w=150',
                createdAt: new Date().toISOString()
              });
              alert('商品添加成功！');
              addProductForm.reset();
              loadProducts();
            } catch (error) {
              alert('添加失败：' + error.message);
            }
          });
        }

        async function loadProducts(searchTerm = '') {
          const productTable = document.querySelector('#product-manage table');
          productTable.querySelector('tbody').innerHTML = '<tr><td colspan="5" class="loading">加载中...</td></tr>';
          const productsRef = ref(db, 'products');
          onValue(productsRef, (snapshot) => {
            productTable.querySelector('tbody').innerHTML = '';
            if (!snapshot.exists()) {
              productTable.querySelector('tbody').innerHTML = '<tr><td colspan="5" class="loading">暂无商品。</td></tr>';
              return;
            }
            let products = [];
            snapshot.forEach((childSnapshot) => {
              const product = childSnapshot.val();
              product.id = childSnapshot.key;
              products.push(product);
            });
            if (searchTerm) {
              products = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            }
            if (products.length === 0) {
              productTable.querySelector('tbody').innerHTML = '<tr><td colspan="5" class="loading">无匹配商品。</td></tr>';
              return;
            }
            products.forEach((product) => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td>￥${product.price}</td>
                <td>${product.category}</td>
                <td>
                  <button class="btn btn-warning btn-sm" onclick="editProduct('${product.id}')">编辑</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">删除</button>
                </td>
              `;
              productTable.querySelector('tbody').appendChild(row);
            });
          });
        }

        window.deleteProduct = async function(id) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          if (confirm('确定删除此商品？')) {
            await remove(ref(db, `products/${id}`));
            alert('商品删除成功！');
          }
        };

        window.editProduct = async function(id) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          const productRef = ref(db, `products/${id}`);
          onValue(productRef, (snapshot) => {
            const product = snapshot.val();
            if (product) {
              const newName = prompt('请输入新商品名称：', product.name);
              const newPrice = parseFloat(prompt('请输入新价格：', product.price));
              const newDescription = prompt('请输入新描述：', product.description);
              const newCategory = prompt('请输入新分类：', product.category);
              const newImageUrl = prompt('请输入新图片URL：', product.imageUrl);
              if (newName && !isNaN(newPrice) && newDescription && newCategory) {
                updateProduct(id, newName, newPrice, newDescription, newCategory, newImageUrl);
              }
            }
          }, { onlyOnce: true });
        };

        async function updateProduct(id, name, price, description, category, imageUrl) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          await update(ref(db, `products/${id}`), {
            name, price, description, category,
            imageUrl: imageUrl || 'https://images.pexels.com/photos/3400193/pexels-photo-3400193.jpeg?auto=compress&cs=tinysrgb&w=150'
          });
          alert('商品更新成功！');
        }

        async function loadOrders(searchTerm = '', limit = 10) {
          const orderTable = document.querySelector('#order-manage table');
          orderTable.querySelector('tbody').innerHTML = '<tr><td colspan="7" class="loading">加载中...</td></tr>';
          const ordersRef = ref(db, 'orders');
          onValue(ordersRef, (snapshot) => {
            orderTable.querySelector('tbody').innerHTML = '';
            if (!snapshot.exists()) {
              orderTable.querySelector('tbody').innerHTML = '<tr><td colspan="7" class="loading">暂无订单。</td></tr>';
              return;
            }
            let orders = [];
            snapshot.forEach((childSnapshot) => {
              const order = childSnapshot.val();
              order.id = childSnapshot.key;
              orders.push(order);
            });
            if (searchTerm) {
              orders = orders.filter(o => o.id.includes(searchTerm) || (o.customerName && o.customerName.toLowerCase().includes(searchTerm.toLowerCase())));
            }
            orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            orders = orders.slice(0, limit);
            if (orders.length === 0) {
              orderTable.querySelector('tbody').innerHTML = '<tr><td colspan="7" class="loading">无匹配订单。</td></tr>';
              return;
            }
            orders.forEach((order) => {
              let itemsList = '未知商品';
              if (Array.isArray(order.items)) {
                itemsList = order.items.map(item => `${item.name} x ${item.quantity}`).join(', ');
              } else if (order.items && typeof order.items === 'object') {
                itemsList = Object.values(order.items).map(item => `${item.name} x ${item.quantity}`).join(', ');
              }
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${order.id}</td>
                <td>${order.customerName || '未知客户'}</td>
                <td>${order.customerPhone || '无电话'}</td>
                <td>${itemsList}</td>
                <td>￥${order.total || 0}</td>
                <td>${order.status || '未知'}</td>
                <td>
                  <button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.id}', 'completed')">完成</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}')">删除</button>
                </td>
              `;
              orderTable.querySelector('tbody').appendChild(row);
            });
          }, (error) => {
            console.error('Error loading orders:', error.message);
            orderTable.querySelector('tbody').innerHTML = '<tr><td colspan="7" class="loading">加载订单失败，请稍后重试。</td></tr>';
          });
        }

        window.updateOrderStatus = async function(orderId, status) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          await update(ref(db, `orders/${orderId}`), { status });
          alert('订单状态更新成功！');
        };

        window.deleteOrder = async function(orderId) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          if (confirm('确定删除此订单？')) {
            await remove(ref(db, `orders/${orderId}`));
            alert('订单删除成功！');
          }
        }

        // 添加搜索功能
        const productSearchInput = document.getElementById('product-search');
        if (productSearchInput) {
          productSearchInput.addEventListener('input', (e) => {
            loadProducts(e.target.value);
          });
        }

        const orderSearchInput = document.getElementById('order-search');
        if (orderSearchInput) {
          orderSearchInput.addEventListener('input', (e) => {
            loadOrders(e.target.value);
          });
        }

        if (isAdmin) {
          loadProducts();
          loadOrders();
        }
      }

      document.addEventListener('DOMContentLoaded', initializeAppLogic);
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      alert('Firebase 初始化失败，请检查配置或网络！');
    }
  </script>
</head>
<body>
  <section id="admin-login" class="admin-section">
    <div class="container">
      <h2>管理员登录</h2>
      <form>
        <div class="mb-3">
          <label for="email" class="form-label">邮箱</label>
          <input type="email" class="form-control" id="email" placeholder="请输入邮箱" required>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">密码</label>
          <input type="password" class="form-control" id="password" placeholder="请输入密码" required>
        </div>
        <div id="error-message" class="error-message"></div>
        <button type="submit" class="btn btn-primary">登录</button>
      </form>
      <a href="/" class="btn btn-secondary mt-3 d-block text-center">返回主页</a>
    </div>
  </section>

  <div id="admin-sections">
    <section id="product-manage" class="admin-section">
      <div class="container">
        <h2>商品管理</h2>
        <div class="search-bar">
          <input type="text" id="product-search" class="form-control mb-3" placeholder="搜索商品名称...">
        </div>
        <button class="btn btn-primary mb-3" onclick="document.getElementById('add-product').style.display='block'">添加商品</button>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>名称</th>
                <th>价格</th>
                <th>分类</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <!-- 商品会通过JavaScript动态加载 -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="order-manage" class="admin-section">
      <div class="container">
        <h2>订单管理</h2>
        <div class="search-bar">
          <input type="text" id="order-search" class="form-control mb-3" placeholder="搜索订单ID或客户姓名...">
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>客户姓名</th>
                <th>电话号码</th>
                <th>商品</th>
                <th>总金额</th>
                <th>状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <!-- 订单会通过JavaScript动态加载 -->
            </tbody>
          </table>
        </div>
        <div class="pagination">
          <select class="form-select w-auto" id="order-limit" onchange="loadOrders(document.getElementById('order-search').value, this.value)">
            <option value="10">10 条/页</option>
            <option value="20">20 条/页</option>
            <option value="50">50 条/页</option>
          </select>
        </div>
      </div>
    </section>

    <section id="add-product" class="admin-section" style="display:none;">
      <div class="container">
        <h2>添加商品</h2>
        <form>
          <div class="mb-3">
            <label for="name" class="form-label">商品名称</label>
            <input type="text" class="form-control" name="name" placeholder="请输入商品名称" required>
          </div>
          <div class="mb-3">
            <label for="price" class="form-label">价格</label>
            <input type="number" step="0.01" class="form-control" name="price" placeholder="请输入价格" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">商品描述</label>
            <textarea class="form-control" name="description" rows="3" placeholder="请输入商品描述" required></textarea>
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">分类</label>
            <select class="form-control" name="category" required>
              <option value="特色咖啡">特色咖啡</option>
              <option value="茶类饮品">茶类饮品</option>
              <option value="甜点蛋糕">甜点蛋糕</option>
              <option value="简餐小食">简餐小食</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="imageUrl" class="form-label">图片 URL</label>
            <input type="text" class="form-control" name="imageUrl" placeholder="请输入图片 URL">
          </div>
          <button type="submit" class="btn btn-success">保存</button>
          <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.style.display='none'">取消</button>
        </form>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
