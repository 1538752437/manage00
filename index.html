<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Muphy Coffee - 管理员界面</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Arial', sans-serif; background-color: #f8f9fa; color: #333; }
    .admin-section { padding: 40px 0; background-color: #fff; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #6f4e37; border-color: #6f4e37; }
    .btn-primary:hover { background-color: #5a3f2d; border-color: #5a3f2d; }
    .btn-success { background-color: #28a745; border-color: #28a745; }
    .btn-success:hover { background-color: #218838; border-color: #218838; }
    .btn-danger { background-color: #dc3545; border-color: #dc3545; }
    .btn-danger:hover { background-color: #c82333; border-color: #c82333; }
    .table { background-color: #fff; }
    .loading { text-align: center; color: #6f4e37; font-style: italic; }
    #admin-sections { display: none; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaVwadaKpdjtYPN1qWIvh6Rkben-Y5KQ",
      authDomain: "muphycoffee.firebaseapp.com",
      databaseURL: "https://muphycoffee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "muphycoffee",
      storageBucket: "muphycoffee.firebasestorage.app",
      messagingSenderId: "247009315808",
      appId: "1:247009315808:web:9a63a7648509cc42c0b985",
      measurementId: "G-B5ZT58WP1Q"
    };

    try {
      console.log('Initializing Firebase...');
      const app = initializeApp(firebaseConfig);
      console.log('Firebase initialized successfully:', app);
      const analytics = getAnalytics(app);
      const db = getDatabase(app);
      const auth = getAuth(app);
      console.log('Firebase services initialized:', { analytics, db, auth });

      let isAdmin = false;

      async function initializeAppLogic() {
        console.log('Starting application logic...');

        const loginContainer = document.getElementById('admin-login');
        if (!loginContainer) {
          console.error('Login container not found in DOM!');
          return;
        }
        const loginForm = loginContainer.querySelector('form');
        if (!loginForm) {
          console.error('Login form not found in DOM!');
          return;
        }
        console.log('Login form found, attaching submit event listener...');
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          console.log('Login form submitted at', new Date().toISOString());
          const emailInput = loginContainer.querySelector('input[type="email"]');
          const passwordInput = loginContainer.querySelector('input[type="password"]');
          if (!emailInput || !passwordInput) {
            console.error('Email or password input not found!');
            alert('表单元素缺失，请检查页面！');
            return;
          }
          const email = emailInput.value.trim();
          const password = passwordInput.value.trim();
          console.log('Login attempt with:', { email, passwordLength: password.length });
          if (!email || !password) {
            console.warn('Empty email or password');
            alert('请输入邮箱和密码！');
            return;
          }
          try {
            console.log('Calling signInWithEmailAndPassword...');
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            console.log('Login successful, user:', userCredential.user);
            isAdmin = true;
            alert('登录成功！');
            loginContainer.style.display = 'none';
            document.getElementById('admin-sections').style.display = 'block';
            const logoutButton = document.createElement('button');
            logoutButton.type = 'button';
            logoutButton.textContent = '退出登录';
            logoutButton.className = 'btn btn-secondary mt-3';
            loginContainer.appendChild(logoutButton);
            logoutButton.addEventListener('click', async () => {
              try {
                await signOut(auth);
                console.log('Logged out successfully');
                alert('已退出登录！');
                isAdmin = false;
                document.getElementById('admin-sections').style.display = 'none';
                loginContainer.style.display = 'block';
                logoutButton.remove();
              } catch (error) {
                console.error('Logout failed:', error.message);
                alert('退出登录失败：' + error.message);
              }
            });
            logoutButton.style.display = 'block';
            await loadProducts();
            await loadOrders();
          } catch (error) {
            console.error('Login failed:', error.code, error.message);
            alert('登录失败：' + error.message);
          }
        });

        onAuthStateChanged(auth, (user) => {
          console.log('Auth state changed, user:', user ? user.uid : 'none');
          const logoutButton = loginContainer.querySelector('button[type="button"]');
          if (user) {
            isAdmin = true;
            document.getElementById('admin-sections').style.display = 'block';
            loginContainer.style.display = 'none';
            if (logoutButton) logoutButton.style.display = 'block';
            loadProducts();
            loadOrders();
          } else {
            isAdmin = false;
            document.getElementById('admin-sections').style.display = 'none';
            loginContainer.style.display = 'block';
            if (logoutButton) logoutButton.style.display = 'none';
          }
        });

        const addProductForm = document.querySelector('#add-product form');
        if (addProductForm) {
          addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) {
              alert('请先登录管理员账户！');
              return;
            }
            const name = document.querySelector('#add-product input[name="name"]').value.trim();
            const price = parseFloat(document.querySelector('#add-product input[name="price"]').value);
            const description = document.querySelector('#add-product textarea[name="description"]').value.trim();
            const category = document.querySelector('#add-product select[name="category"]').value;
            const imageUrl = document.querySelector('#add-product input[name="imageUrl"]').value.trim();
            if (!name || isNaN(price) || !description || !category) {
              alert('请填写所有必填字段！');
              return;
            }
            try {
              await push(ref(db, 'products'), {
                name, price, description, category,
                imageUrl: imageUrl || 'https://picsum.photos/150/150',
                createdAt: new Date().toISOString()
              });
              alert('商品添加成功！');
              addProductForm.reset();
              loadProducts();
            } catch (error) {
              alert('添加失败：' + error.message);
            }
          });
        }

        async function loadProducts() {
          const productTable = document.querySelector('#product-manage table');
          if (!productTable) return;
          productTable.querySelector('tbody').innerHTML = '<tr><td colspan="5" class="loading">加载中...</td></tr>';

          try {
            const productsRef = ref(db, 'products');
            onValue(productsRef, (snapshot) => {
              productTable.querySelector('tbody').innerHTML = '';
              if (!snapshot.exists()) {
                productTable.querySelector('tbody').innerHTML = '<tr><td colspan="5" class="loading">暂无商品。</td></tr>';
                return;
              }
              snapshot.forEach((childSnapshot) => {
                const product = childSnapshot.val();
                const productId = childSnapshot.key;
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${productId}</td>
                  <td>${product.name}</td>
                  <td>￥${product.price}</td>
                  <td>${product.category}</td>
                  <td>
                    <button class="btn btn-warning btn-sm" onclick="editProduct('${productId}')">编辑</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProduct('${productId}')">删除</button>
                  </td>
                `;
                productTable.querySelector('tbody').appendChild(row);
              });
            }, (error) => {
              console.error('Error loading products:', error.message);
              productTable.querySelector('tbody').innerHTML = '<tr><td colspan="5" class="loading">加载商品失败，请稍后重试。</td></tr>';
            });
          } catch (error) {
            console.error('Error in loadProducts:', error.message);
          }
        }

        window.deleteProduct = async function(id) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          if (confirm('确定删除此商品？')) {
            try {
              await remove(ref(db, `products/${id}`));
              alert('商品删除成功！');
            } catch (error) {
              alert('删除失败：' + error.message);
            }
          }
        };

        window.editProduct = async function(id) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          const productRef = ref(db, `products/${id}`);
          onValue(productRef, (snapshot) => {
            const product = snapshot.val();
            if (product) {
              const newName = prompt('请输入新商品名称：', product.name);
              const newPrice = parseFloat(prompt('请输入新价格：', product.price));
              const newDescription = prompt('请输入新描述：', product.description);
              const newCategory = prompt('请输入新分类：', product.category);
              const newImageUrl = prompt('请输入新图片URL：', product.imageUrl);
              if (newName && !isNaN(newPrice) && newDescription && newCategory) {
                updateProduct(id, newName, newPrice, newDescription, newCategory, newImageUrl);
              }
            }
          }, { onlyOnce: true });
        };

        async function updateProduct(id, name, price, description, category, imageUrl) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          try {
            await update(ref(db, `products/${id}`), {
              name, price, description, category,
              imageUrl: imageUrl || 'https://picsum.photos/150/150'
            });
            alert('商品更新成功！');
          } catch (error) {
            alert('更新失败：' + error.message);
          }
        }

        async function loadOrders() {
          const orderTable = document.querySelector('#order-manage table');
          if (!orderTable) return;
          orderTable.querySelector('tbody').innerHTML = '<tr><td colspan="6" class="loading">加载中...</td></tr>';

          try {
            const ordersRef = ref(db, 'orders');
            onValue(ordersRef, (snapshot) => {
              orderTable.querySelector('tbody').innerHTML = '';
              if (!snapshot.exists()) {
                orderTable.querySelector('tbody').innerHTML = '<tr><td colspan="6" class="loading">暂无订单。</td></tr>';
                return;
              }
              snapshot.forEach((childSnapshot) => {
                const order = childSnapshot.val();
                const orderId = childSnapshot.key;
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${orderId}</td>
                  <td>${order.customerName || '未知客户'}</td>
                  <td>${order.customerPhone || '无电话'}</td>
                  <td>￥${order.total || 0}</td>
                  <td>${order.status || '未知'}</td>
                  <td>
                    <button class="btn btn-success btn-sm" onclick="updateOrderStatus('${orderId}', 'completed')">完成</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteOrder('${orderId}')">删除</button>
                  </td>
                `;
                orderTable.querySelector('tbody').appendChild(row);
              });
            }, (error) => {
              console.error('Error loading orders:', error.message);
              orderTable.querySelector('tbody').innerHTML = '<tr><td colspan="6" class="loading">加载订单失败，请稍后重试。</td></tr>';
            });
          } catch (error) {
            console.error('Error in loadOrders:', error.message);
          }
        }

        window.updateOrderStatus = async function(orderId, status) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          try {
            await update(ref(db, `orders/${orderId}`), { status });
            alert('订单状态更新成功！');
          } catch (error) {
            alert('更新失败：' + error.message);
          }
        };

        window.deleteOrder = async function(orderId) {
          if (!isAdmin) {
            alert('请先登录管理员账户！');
            return;
          }
          if (confirm('确定删除此订单？')) {
            try {
              await remove(ref(db, `orders/${orderId}`));
              alert('订单删除成功！');
            } catch (error) {
              alert('删除失败：' + error.message);
            }
          }
        }

        if (isAdmin) {
          loadProducts();
          loadOrders();
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM fully loaded at', new Date().toISOString());
        initializeAppLogic().catch(error => console.error('Application initialization failed:', error));
      });
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      alert('Firebase 初始化失败，请检查配置或网络！');
    }
  </script>
</head>
<body>
  <section id="admin-login" class="admin-section">
    <div class="container">
      <h2>管理员登录</h2>
      <form>
        <div class="mb-3">
          <label for="email" class="form-label">邮箱</label>
          <input type="email" class="form-control" id="email" placeholder="请输入邮箱" required>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">密码</label>
          <input type="password" class="form-control" id="password" placeholder="请输入密码" required>
        </div>
        <button type="submit" class="btn btn-primary">登录</button>
      </form>
      <a href="/" class="btn btn-secondary mt-3">返回主页</a>
    </div>
  </section>

  <div id="admin-sections">
    <section id="product-manage" class="admin-section">
      <div class="container">
        <h2>商品管理</h2>
        <button class="btn btn-primary mb-3" onclick="document.getElementById('add-product').style.display='block'">添加商品</button>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>名称</th>
              <th>价格</th>
              <th>分类</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- 商品会通过JavaScript动态加载 -->
          </tbody>
        </table>
      </div>
    </section>

    <section id="order-manage" class="admin-section">
      <div class="container">
        <h2>订单管理</h2>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>客户姓名</th>
              <th>电话号码</th>
              <th>总金额</th>
              <th>状态</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- 订单会通过JavaScript动态加载 -->
          </tbody>
        </table>
      </div>
    </section>

    <section id="add-product" class="admin-section" style="display:none;">
      <div class="container">
        <h2>添加商品</h2>
        <form>
          <div class="mb-3">
            <label for="name" class="form-label">商品名称</label>
            <input type="text" class="form-control" name="name" placeholder="请输入商品名称" required>
          </div>
          <div class="mb-3">
            <label for="price" class="form-label">价格</label>
            <input type="number" step="0.01" class="form-control" name="price" placeholder="请输入价格" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">商品描述</label>
            <textarea class="form-control" name="description" rows="3" placeholder="请输入商品描述" required></textarea>
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">分类</label>
            <select class="form-control" name="category" required>
              <option value="特色咖啡">特色咖啡</option>
              <option value="茶类饮品">茶类饮品</option>
              <option value="甜点蛋糕">甜点蛋糕</option>
              <option value="简餐小食">简餐小食</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="imageUrl" class="form-label">图片 URL</label>
            <input type="text" class="form-control" name="imageUrl" placeholder="请输入图片 URL">
          </div>
          <button type="submit" class="btn btn-success">保存</button>
          <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.style.display='none'">取消</button>
        </form>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
